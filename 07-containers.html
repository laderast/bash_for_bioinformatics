<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.2.335">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Bash for Bioinformatics - 8&nbsp; Containers and Reproducibility</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { color: #008000; } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { color: #008000; font-weight: bold; } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./appendix.html" rel="next">
<link href="./06-JSON.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-QM3D3CT5J5"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-QM3D3CT5J5', { 'anonymize_ip': true});
</script>
<script type="application/json" class="js-hypothesis-config">
{
  "theme": "clean",
  "openSidebar": false
}
</script>
<script async="" src="https://hypothes.is/embed.js"></script>
<script src="site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Containers and Reproducibility</span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Bash for Bioinformatics</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-setup-course.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Setup for the Course / dx-toolkit basics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-scripting-basics.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Shell Scripting Basics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-cloud-computing-basics.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Cloud Computing Basics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-doing-work-with-dx-run.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Working with files using <code>dx run</code></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-batch-processing.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Batch Processing on the Cloud</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-JSON.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Working with JSON on the DNAnexus Platform</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-containers.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Containers and Reproducibility</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendix.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Appendix</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives"><span class="toc-section-number">8.1</span>  Learning Objectives</a></li>
  <li><a href="#why-containers" id="toc-why-containers" class="nav-link" data-scroll-target="#why-containers"><span class="toc-section-number">8.2</span>  Why Containers?</a></li>
  <li><a href="#terminology" id="toc-terminology" class="nav-link" data-scroll-target="#terminology"><span class="toc-section-number">8.3</span>  Terminology</a></li>
  <li><a href="#building-docker-snapshot-files-on-the-the-dnanexus-platform" id="toc-building-docker-snapshot-files-on-the-the-dnanexus-platform" class="nav-link" data-scroll-target="#building-docker-snapshot-files-on-the-the-dnanexus-platform"><span class="toc-section-number">8.4</span>  Building Docker Snapshot Files on the the DNAnexus platform</a>
  <ul class="collapse">
  <li><a href="#the-golden-rule-of-docker-and-batch-analysis" id="toc-the-golden-rule-of-docker-and-batch-analysis" class="nav-link" data-scroll-target="#the-golden-rule-of-docker-and-batch-analysis"><span class="toc-section-number">8.4.1</span>  The Golden Rule of Docker and Batch Analysis</a></li>
  <li><a href="#be-secure" id="toc-be-secure" class="nav-link" data-scroll-target="#be-secure"><span class="toc-section-number">8.4.2</span>  Be Secure</a></li>
  <li><a href="#the-basic-snapshot-building-process" id="toc-the-basic-snapshot-building-process" class="nav-link" data-scroll-target="#the-basic-snapshot-building-process"><span class="toc-section-number">8.4.3</span>  The Basic Snapshot Building Process</a></li>
  <li><a href="#sec-ttyd" id="toc-sec-ttyd" class="nav-link" data-scroll-target="#sec-ttyd"><span class="toc-section-number">8.4.4</span>  Building Snapshot Files in <code>ttyd</code></a></li>
  <li><a href="#pull-your-image-from-a-registry" id="toc-pull-your-image-from-a-registry" class="nav-link" data-scroll-target="#pull-your-image-from-a-registry"><span class="toc-section-number">8.4.5</span>  Pull your image from a registry</a></li>
  <li><a href="#save-your-docker-image-as-a-snapshot" id="toc-save-your-docker-image-as-a-snapshot" class="nav-link" data-scroll-target="#save-your-docker-image-as-a-snapshot"><span class="toc-section-number">8.4.6</span>  Save your docker image as a snapshot</a></li>
  <li><a href="#upload-your-snapshot" id="toc-upload-your-snapshot" class="nav-link" data-scroll-target="#upload-your-snapshot"><span class="toc-section-number">8.4.7</span>  Upload your snapshot</a></li>
  <li><a href="#important-make-sure-to-terminate-your-ttyd-instance" id="toc-important-make-sure-to-terminate-your-ttyd-instance" class="nav-link" data-scroll-target="#important-make-sure-to-terminate-your-ttyd-instance"><span class="toc-section-number">8.4.8</span>  Important: make sure to terminate your ttyd instance!</a></li>
  </ul></li>
  <li><a href="#sec-docker-sak" id="toc-sec-docker-sak" class="nav-link" data-scroll-target="#sec-docker-sak"><span class="toc-section-number">8.5</span>  Using Docker with Swiss Army Knife</a></li>
  <li><a href="#extending-a-docker-image" id="toc-extending-a-docker-image" class="nav-link" data-scroll-target="#extending-a-docker-image"><span class="toc-section-number">8.6</span>  Extending a Docker Image</a>
  <ul class="collapse">
  <li><a href="#pulling-a-base-image" id="toc-pulling-a-base-image" class="nav-link" data-scroll-target="#pulling-a-base-image"><span class="toc-section-number">8.6.1</span>  Pulling a Base Image</a></li>
  <li><a href="#open-up-interactive-mode" id="toc-open-up-interactive-mode" class="nav-link" data-scroll-target="#open-up-interactive-mode"><span class="toc-section-number">8.6.2</span>  Open up interactive mode</a></li>
  <li><a href="#install-software" id="toc-install-software" class="nav-link" data-scroll-target="#install-software"><span class="toc-section-number">8.6.3</span>  Install Software</a></li>
  <li><a href="#exit-container" id="toc-exit-container" class="nav-link" data-scroll-target="#exit-container"><span class="toc-section-number">8.6.4</span>  Exit Container</a></li>
  <li><a href="#docker-commitdocker-save-your-new-snapshot-file" id="toc-docker-commitdocker-save-your-new-snapshot-file" class="nav-link" data-scroll-target="#docker-commitdocker-save-your-new-snapshot-file"><span class="toc-section-number">8.6.5</span>  <code>docker commit</code>/<code>docker save</code> your new snapshot file</a></li>
  </ul></li>
  <li><a href="#other-uses-of-interactive-mode" id="toc-other-uses-of-interactive-mode" class="nav-link" data-scroll-target="#other-uses-of-interactive-mode"><span class="toc-section-number">8.7</span>  Other uses of Interactive Mode</a></li>
  <li><a href="#going-further-with-docker" id="toc-going-further-with-docker" class="nav-link" data-scroll-target="#going-further-with-docker"><span class="toc-section-number">8.8</span>  Going Further with Docker</a></li>
  <li><a href="#what-you-learned-in-this-chapter" id="toc-what-you-learned-in-this-chapter" class="nav-link" data-scroll-target="#what-you-learned-in-this-chapter"><span class="toc-section-number">8.9</span>  What you learned in this chapter</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-containers" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Containers and Reproducibility</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<section id="learning-objectives" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="learning-objectives"><span class="header-section-number">8.1</span> Learning Objectives</h2>
<ol type="1">
<li><strong>Explain</strong> the benefits of using containers on DNAnexus for reproducibility and for batch processing</li>
<li><strong>Define</strong> the terms <em>image</em>, <em>container</em>, and <em>snapshot</em> in the context of Docker</li>
<li><strong>Create</strong> snapshots on RAP using <code>docker pull</code> and <code>docker save</code> with the ttyd app</li>
<li><strong>Utilize</strong> containers to batch process files on RAP</li>
<li><strong>Extend</strong> a docker image by installing within interactive mode</li>
</ol>
</section>
<section id="why-containers" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="why-containers"><span class="header-section-number">8.2</span> Why Containers?</h2>
<p>There is a replication crisis out there. Even given a script and the raw data, it is often difficult to replicate the results generated by a study.</p>
<p>Why is this difficult? Many others have talked about this, but one simple reason is that the results are tied to software and database versions.</p>
<p>This is the motivation for using <em>containers</em> - they are a way of packaging software that ‘freezes’ the software versions. If you provide the container that you used to generate the results, other people should be able to replicate your results even if they’re on a different operating system.</p>
</section>
<section id="terminology" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="terminology"><span class="header-section-number">8.3</span> Terminology</h2>
<p>In order to be unambiguous with our language, we’ll use the following definitions:</p>
<div id="fig-docker1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/docker_terminology.png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Figure&nbsp;8.1: Docker Terms 1</figcaption><p></p>
</figure>
</div>
<ul>
<li><strong>Registry</strong> - collection of repositories that you pull docker images from. Example repositories include DockerHub and Quay.io.</li>
<li><strong>Docker Image</strong> - what you download from a registry - the “recipe” for building the software environment. Stored in a registry. use <code>docker pull</code> to get image, <code>docker commit</code> to push changes to registry, can also generate image from a Dockerfile,</li>
<li><strong>Docker Container</strong> - The executable software environment installed on a machine. Runnable. Generate from <code>docker pull</code> from a repository.</li>
<li><strong>Snapshot File</strong> - An single archive file (<code>.tar.gz</code>) that contains the Docker container. Generate using <code>docker save</code> on a container. Also known as an <em>image file</em> on the platform.</li>
</ul>
</section>
<section id="building-docker-snapshot-files-on-the-the-dnanexus-platform" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="building-docker-snapshot-files-on-the-the-dnanexus-platform"><span class="header-section-number">8.4</span> Building Docker Snapshot Files on the the DNAnexus platform</h2>
<section id="the-golden-rule-of-docker-and-batch-analysis" class="level3" data-number="8.4.1">
<h3 data-number="8.4.1" class="anchored" data-anchor-id="the-golden-rule-of-docker-and-batch-analysis"><span class="header-section-number">8.4.1</span> The Golden Rule of Docker and Batch Analysis</h3>
<p>DockerHub has a pull limit of 200 pulls/day/user. You will face this limit a lot if you just use the image url.</p>
<p>So, if you are processing more than 200 files (or Jobs), you should save the docker image into platform storage as a snapshot file.</p>
<p>Let’s talk about the basic snapshot building process.</p>
</section>
<section id="be-secure" class="level3" data-number="8.4.2">
<h3 data-number="8.4.2" class="anchored" data-anchor-id="be-secure"><span class="header-section-number">8.4.2</span> Be Secure</h3>
<p>Security is always a concern when running Docker images. The <code>docker</code> group has elevated status on a system, so we need to be careful that when we’re running them, they aren’t introducing any system vulnerabilities.</p>
<p>These are mostly important when running containers that are web-servers or part of a web stack, but it is also important to think about when running jobs on the cloud.</p>
<p>Here are some guidelines to think about when you are working with a container.</p>
<ul>
<li><strong>Use vendor-specific Docker Images when possible</strong>.</li>
<li><strong>Use container scanners to spot potential vulnerabilities</strong>. DockerHub has a vulnerability scanner that scans your Docker images for potential vulnerabilities.</li>
<li><strong>Avoid kitchen-sink images</strong>. One issue is when an image is built on top of many other images. It makes it really difficult.</li>
</ul>
</section>
<section id="the-basic-snapshot-building-process" class="level3" data-number="8.4.3">
<h3 data-number="8.4.3" class="anchored" data-anchor-id="the-basic-snapshot-building-process"><span class="header-section-number">8.4.3</span> The Basic Snapshot Building Process</h3>
<div id="fig-snapshot-building" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div class="cell">
<div class="cell-output-display">
<div>
<p>
</p><pre class="mermaid mermaid-js" data-tooltip-selector="#mermaid-tooltip-1">flowchart TD
  A[start ttyd] --&gt; B[docker pull &lt;br&gt; from registry]
  B --&gt; C[docker save to &lt;br&gt; snapshot file]
  C --&gt; D[dx upload &lt;br&gt; snapshot to &lt;br&gt; project storage]
  D --&gt; E[terminate ttyd]
</pre>
<div id="mermaid-tooltip-1" class="mermaidTooltip">

</div>
<p></p>
</div>
</div>
</div>
<p></p><figcaption class="figure-caption">Figure&nbsp;8.2: Building a docker snapshot on the DNAnexus platform.</figcaption><p></p>
</figure>
</div>
</section>
<section id="sec-ttyd" class="level3" data-number="8.4.4">
<h3 data-number="8.4.4" class="anchored" data-anchor-id="sec-ttyd"><span class="header-section-number">8.4.4</span> Building Snapshot Files in <code>ttyd</code></h3>
<p>Up until now, we have been using our own machine or the binder shell for doing our work.</p>
<p>We’re going to pull up a web-enabled shell on a DNAnexus worker with the <code>ttyd</code> app. <code>ttyd</code> is useful because:</p>
<ol type="1">
<li><code>docker</code> is already installed, so we can <code>docker pull</code> our container and <code>docker save</code> our snapshot to the ttyd instance.</li>
<li>It’s much faster to transfer our snapshot file back into project storage..</li>
</ol>
<p>To open ttyd, open the <strong>Tool Library</strong> under <strong>Tools</strong> and select your project.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src=".png" class="img-fluid figure-img"></p>
<p></p><figcaption class="figure-caption">Opening ttyd</figcaption><p></p>
</figure>
</div>
</section>
<section id="pull-your-image-from-a-registry" class="level3" data-number="8.4.5">
<h3 data-number="8.4.5" class="anchored" data-anchor-id="pull-your-image-from-a-registry"><span class="header-section-number">8.4.5</span> Pull your image from a registry</h3>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> pull quay.io/biocontainers/samtools:1.15.1--h1170115_0</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>On your <code>ttyd</code> instance, do a <code>docker pull</code> to pull your image from the registry. Note that we’re pulling <code>samtools</code> from <code>quay.io</code> here, from the <code>biocontainers</code> user.</p>
<p>We’re also specifying a <em>version tag</em> - the <code>1.15.1--h1170115_0</code> to tie our <code>samtools</code> to a specific version. This is important - most <code>docker pull</code> operations will pull from the <code>latest</code> tag, which is not tied to a specific version. So make sure to tie your image to a specific version.</p>
<p>When you’re done pulling the docker image, try out the <code>docker images</code> command.</p>
<pre><code>docker images</code></pre>
</section>
<section id="save-your-docker-image-as-a-snapshot" class="level3" data-number="8.4.6">
<h3 data-number="8.4.6" class="anchored" data-anchor-id="save-your-docker-image-as-a-snapshot"><span class="header-section-number">8.4.6</span> Save your docker image as a snapshot</h3>
<div class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> save quay.io/biocontainers/samtools <span class="kw">|</span> <span class="fu">gzip</span> <span class="op">&gt;</span> samtools_image.tar.gz </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now that we’ve pulled the container, we are now going to save it as a snapshot file using <code>docker save</code>. We pipe the output of <code>docker save</code> into <code>gzip</code> to save it as <code>samtools_image.tar.gz</code></p>
</section>
<section id="upload-your-snapshot" class="level3" data-number="8.4.7">
<h3 data-number="8.4.7" class="anchored" data-anchor-id="upload-your-snapshot"><span class="header-section-number">8.4.7</span> Upload your snapshot</h3>
<div class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dx</span> mkdir images/</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">dx</span> upload samtools_image.tar.gz <span class="at">--destination</span> images/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we can get our image back into project storage. We’ll create a folder called <code>images/</code> and then use <code>dx upload</code> to get our snapshot file.</p>
</section>
<section id="important-make-sure-to-terminate-your-ttyd-instance" class="level3" data-number="8.4.8">
<h3 data-number="8.4.8" class="anchored" data-anchor-id="important-make-sure-to-terminate-your-ttyd-instance"><span class="header-section-number">8.4.8</span> Important: make sure to terminate your ttyd instance!</h3>
<p>One thing to remember is that there is no timeout associated with <code>ttyd</code>. You will get a reminder email after it’s been open after 24 hours, but you will get no warning after that.</p>
<p>So make sure to use <code>dx terminate</code> to terminate your ttyd job.</p>
</section>
</section>
<section id="sec-docker-sak" class="level2" data-number="8.5">
<h2 data-number="8.5" class="anchored" data-anchor-id="sec-docker-sak"><span class="header-section-number">8.5</span> Using Docker with Swiss Army Knife</h2>
<p>Now that we’ve built our Docker snapshot, let’s use it in Swiss Army Knife.</p>
<p>Swiss Army Knife has two separate inputs associated with Docker:</p>
<ul>
<li><code>-iimage_file</code> - This is where you put the snapshot file (such as the <code>samtools.tar.gz</code>)</li>
<li><code>-iimage</code> - This is where you’d put the Docker URL (such as <code>quay.io/ucsc_cgl/samtools</code>)</li>
</ul>
<p>So, let’s run a <code>samtools</code> job using our Docker snapshot.</p>
<div class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">dx</span> run app-swiss-army-knife <span class="dt">\</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">-iimage_file</span><span class="op">=</span><span class="st">"images/samtools.tar.gz"</span> <span class="dt">\</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">-iin</span><span class="op">=</span><span class="st">"data/NA12878.bam"</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="ex">-icmd=</span><span class="st">"docker run samtools stats * &gt; </span><span class="va">${in_prefix}</span><span class="st">.stats.txt"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The main thing that has been changed here is that we’ve added an the <code>-iimage_file</code> input to our <code>dx run</code> statement.</p>
</section>
<section id="extending-a-docker-image" class="level2" data-number="8.6">
<h2 data-number="8.6" class="anchored" data-anchor-id="extending-a-docker-image"><span class="header-section-number">8.6</span> Extending a Docker Image</h2>
<p>One thing that you might do is extend a Docker image by adding additional software. You can do this by opening up an interactive mode and installing within the container.</p>
<p>What is interactive mode? When you pull a docker image in your <code>ttyd</code> session (<a href="#sec-ttyd"><span>Section&nbsp;8.4.4</span></a>), you can issue a <code>docker run</code> command with these options:</p>
<pre><code>docker run -it ubuntu:18.04 /bin/bash</code></pre>
<p>It will open up a bash shell in the container.</p>
<section id="pulling-a-base-image" class="level3" data-number="8.6.1">
<h3 data-number="8.6.1" class="anchored" data-anchor-id="pulling-a-base-image"><span class="header-section-number">8.6.1</span> Pulling a Base Image</h3>
<p>We’ll start out with the official ubuntu 18.04 container in our ttyd session:</p>
<div class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> pull ubuntu:18.04</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> images</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="open-up-interactive-mode" class="level3" data-number="8.6.2">
<h3 data-number="8.6.2" class="anchored" data-anchor-id="open-up-interactive-mode"><span class="header-section-number">8.6.2</span> Open up interactive mode</h3>
<p>In ttyd, now enter an interactive session:</p>
<pre><code>docker run -it ubuntu:18.04 /bin/bash</code></pre>
<p>If it works, you will open up a <code>bash</code> prompt in the container.</p>
<p>You’ll know you’re in the container if you do an <code>ls</code> and your filesystem looks different.</p>
</section>
<section id="install-software" class="level3" data-number="8.6.3">
<h3 data-number="8.6.3" class="anchored" data-anchor-id="install-software"><span class="header-section-number">8.6.3</span> Install Software</h3>
<p>Now, let’s install <a href="https://emboss.sourceforge.net/">EMBOSS</a> (European Molecular Biology Open Software Suite), which is a suite of string utilities for working with genomic data. If you look at the EMBOSS link, you will see that you can install it via <code>apt install</code>, which is available by default in the <code>ubuntu</code> container.</p>
<div class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> update <span class="kw">&amp;&amp;</span> <span class="ex">apt</span> upgrade</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">apt</span> install emboss gzip <span class="at">-y</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="exit-container" class="level3" data-number="8.6.4">
<h3 data-number="8.6.4" class="anchored" data-anchor-id="exit-container"><span class="header-section-number">8.6.4</span> Exit Container</h3>
<p>Now exit from your container’s interactive mode:</p>
<div class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="bu">exit</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>You’ll be back at the normal ttyd prompt.</p>
</section>
<section id="docker-commitdocker-save-your-new-snapshot-file" class="level3" data-number="8.6.5">
<h3 data-number="8.6.5" class="anchored" data-anchor-id="docker-commitdocker-save-your-new-snapshot-file"><span class="header-section-number">8.6.5</span> <code>docker commit</code>/<code>docker save</code> your new snapshot file</h3>
<p>We created a new container when we installed everything. We’ll need to find it its ID in ttyd.</p>
<div class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> ps <span class="at">-a</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can see that our new container has the following id. We can use this id to save a new container with <code>docker commit</code>. Now we can save the snapshot file by using <code>docker save</code>:</p>
<div class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> commit <span class="op">&lt;</span>container_id<span class="op">&gt;</span> emboss:6.6.0</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="ex">docker</span> save emboss:6.6.0 <span class="kw">|</span> <span class="fu">gzip</span> <span class="op">&gt;</span> emboss.tar.gz</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="ex">dx</span> upload emboss.tar.gz <span class="at">--destination</span> images/</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="other-uses-of-interactive-mode" class="level2" data-number="8.7">
<h2 data-number="8.7" class="anchored" data-anchor-id="other-uses-of-interactive-mode"><span class="header-section-number">8.7</span> Other uses of Interactive Mode</h2>
<p>Docker’s interactive mode is really helpful for testing out scripts and making sure they are reproducible.</p>
<p>If I have a one-off analysis, it may be faster for me to just open up <code>ttyd</code> and use <code>docker run</code> to open up interactive mode, and do work with a container.</p>
</section>
<section id="going-further-with-docker" class="level2" data-number="8.8">
<h2 data-number="8.8" class="anchored" data-anchor-id="going-further-with-docker"><span class="header-section-number">8.8</span> Going Further with Docker</h2>
<p>Now that you know how to build a snapshot file, you’ve also learned another step in building apps: specifying software dependencies. You can use these snapshot files to specify executables in your app.</p>
<p>You can also use these snapshot files in your WDL workflow.</p>
</section>
<section id="what-you-learned-in-this-chapter" class="level2" data-number="8.9">
<h2 data-number="8.9" class="anchored" data-anchor-id="what-you-learned-in-this-chapter"><span class="header-section-number">8.9</span> What you learned in this chapter</h2>
<ul>
<li>How containers enable reproducibility</li>
<li>Defined specific container terminology</li>
<li>Created snapshot files using ttyd</li>
<li>Use these snapshot files with Swiss Army Knife</li>
<li>How to extend a docker image by installing new software</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./06-JSON.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Working with JSON on the DNAnexus Platform</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./appendix.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Appendix</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>