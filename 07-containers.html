<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.450">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Bash for Bioinformatics - 10&nbsp; Containers and Reproducibility</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./appendix.html" rel="next">
<link href="./building-apps.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-QM3D3CT5J5"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-QM3D3CT5J5', { 'anonymize_ip': true});
</script>
<script type="application/json" class="js-hypothesis-config">
{
  "theme": "clean",
  "openSidebar": false
}
</script>
<script async="" src="https://hypothes.is/embed.js"></script>
<script src="site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="site_libs/quarto-diagram/mermaid.css" rel="stylesheet">


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./07-containers.html"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Containers and Reproducibility</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Bash for Bioinformatics</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-setup-course.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Setup for the Course / dx-toolkit basics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-scripting-basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Shell Scripting Basics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-cloud-computing-basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Cloud Computing Basics</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./using-jupyterlabs.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Using JupyterLab on DNAnexus</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-doing-work-with-dx-run.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Working with files using <code>dx run</code></span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-batch-processing.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Batch Processing on the Cloud</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-JSON.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Working with JSON on the DNAnexus Platform</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./building-apps.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Building Apps</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-containers.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Containers and Reproducibility</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendix.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Appendix</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">References</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives"><span class="header-section-number">10.1</span> Learning Objectives</a></li>
  <li><a href="#why-containers" id="toc-why-containers" class="nav-link" data-scroll-target="#why-containers"><span class="header-section-number">10.2</span> Why Containers?</a></li>
  <li><a href="#terminology" id="toc-terminology" class="nav-link" data-scroll-target="#terminology"><span class="header-section-number">10.3</span> Terminology</a></li>
  <li><a href="#building-docker-snapshot-files-on-the-the-dnanexus-platform" id="toc-building-docker-snapshot-files-on-the-the-dnanexus-platform" class="nav-link" data-scroll-target="#building-docker-snapshot-files-on-the-the-dnanexus-platform"><span class="header-section-number">10.4</span> Building Docker Snapshot Files on the the DNAnexus platform</a>
  <ul class="collapse">
  <li><a href="#the-golden-rule-of-docker-and-batch-analysis" id="toc-the-golden-rule-of-docker-and-batch-analysis" class="nav-link" data-scroll-target="#the-golden-rule-of-docker-and-batch-analysis"><span class="header-section-number">10.4.1</span> The Golden Rule of Docker and Batch Analysis</a></li>
  <li><a href="#be-secure" id="toc-be-secure" class="nav-link" data-scroll-target="#be-secure"><span class="header-section-number">10.4.2</span> Be Secure</a></li>
  <li><a href="#the-basic-snapshot-building-process" id="toc-the-basic-snapshot-building-process" class="nav-link" data-scroll-target="#the-basic-snapshot-building-process"><span class="header-section-number">10.4.3</span> The Basic Snapshot Building Process</a></li>
  <li><a href="#sec-ttyd" id="toc-sec-ttyd" class="nav-link" data-scroll-target="#sec-ttyd"><span class="header-section-number">10.4.4</span> Building Snapshot Files in <code>ttyd</code></a></li>
  <li><a href="#pull-your-image-from-a-registry" id="toc-pull-your-image-from-a-registry" class="nav-link" data-scroll-target="#pull-your-image-from-a-registry"><span class="header-section-number">10.4.5</span> Pull your image from a registry</a></li>
  <li><a href="#try-your-docker-image-out" id="toc-try-your-docker-image-out" class="nav-link" data-scroll-target="#try-your-docker-image-out"><span class="header-section-number">10.4.6</span> Try your docker image out</a></li>
  <li><a href="#save-your-docker-image-as-a-snapshot" id="toc-save-your-docker-image-as-a-snapshot" class="nav-link" data-scroll-target="#save-your-docker-image-as-a-snapshot"><span class="header-section-number">10.4.7</span> Save your docker image as a snapshot</a></li>
  <li><a href="#upload-your-snapshot" id="toc-upload-your-snapshot" class="nav-link" data-scroll-target="#upload-your-snapshot"><span class="header-section-number">10.4.8</span> Upload your snapshot</a></li>
  <li><a href="#important-make-sure-to-terminate-your-ttyd-instance" id="toc-important-make-sure-to-terminate-your-ttyd-instance" class="nav-link" data-scroll-target="#important-make-sure-to-terminate-your-ttyd-instance"><span class="header-section-number">10.4.9</span> Important: make sure to terminate your ttyd instance!</a></li>
  </ul></li>
  <li><a href="#sec-docker-sak" id="toc-sec-docker-sak" class="nav-link" data-scroll-target="#sec-docker-sak"><span class="header-section-number">10.5</span> Using Docker with Swiss Army Knife</a></li>
  <li><a href="#extending-a-docker-image" id="toc-extending-a-docker-image" class="nav-link" data-scroll-target="#extending-a-docker-image"><span class="header-section-number">10.6</span> Extending a Docker Image</a>
  <ul class="collapse">
  <li><a href="#pulling-a-base-image" id="toc-pulling-a-base-image" class="nav-link" data-scroll-target="#pulling-a-base-image"><span class="header-section-number">10.6.1</span> Pulling a Base Image</a></li>
  <li><a href="#open-up-interactive-mode" id="toc-open-up-interactive-mode" class="nav-link" data-scroll-target="#open-up-interactive-mode"><span class="header-section-number">10.6.2</span> Open up interactive mode</a></li>
  <li><a href="#install-software" id="toc-install-software" class="nav-link" data-scroll-target="#install-software"><span class="header-section-number">10.6.3</span> Install Software</a></li>
  <li><a href="#exit-container" id="toc-exit-container" class="nav-link" data-scroll-target="#exit-container"><span class="header-section-number">10.6.4</span> Exit Container</a></li>
  <li><a href="#docker-commitdocker-save-your-new-snapshot-file" id="toc-docker-commitdocker-save-your-new-snapshot-file" class="nav-link" data-scroll-target="#docker-commitdocker-save-your-new-snapshot-file"><span class="header-section-number">10.6.5</span> <code>docker commit</code>/<code>docker save</code> your new snapshot file</a></li>
  <li><a href="#other-uses-of-interactive-mode" id="toc-other-uses-of-interactive-mode" class="nav-link" data-scroll-target="#other-uses-of-interactive-mode"><span class="header-section-number">10.6.6</span> Other uses of Interactive Mode</a></li>
  </ul></li>
  <li><a href="#making-dockerfiles" id="toc-making-dockerfiles" class="nav-link" data-scroll-target="#making-dockerfiles"><span class="header-section-number">10.7</span> Making Dockerfiles</a></li>
  <li><a href="#going-further-with-docker" id="toc-going-further-with-docker" class="nav-link" data-scroll-target="#going-further-with-docker"><span class="header-section-number">10.8</span> Going Further with Docker</a></li>
  <li><a href="#what-you-learned-in-this-chapter" id="toc-what-you-learned-in-this-chapter" class="nav-link" data-scroll-target="#what-you-learned-in-this-chapter"><span class="header-section-number">10.9</span> What you learned in this chapter</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-containers" class="quarto-section-identifier"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Containers and Reproducibility</span></span></h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Prep for Exercises
</div>
</div>
<div class="callout-body-container callout-body">
<p>Make sure you are logged into the platform using <code>dx login</code> and that your course project is selected with <code>dx select</code>.</p>
<p>In your shell (either on your machine or in binder), make sure you’re in the <code>bash_bioinfo_scripts/containers/</code> folder:</p>
<pre><code>cd containers/</code></pre>
</div>
</div>
<section id="learning-objectives" class="level2" data-number="10.1">
<h2 data-number="10.1" class="anchored" data-anchor-id="learning-objectives"><span class="header-section-number">10.1</span> Learning Objectives</h2>
<ol type="1">
<li><strong>Explain</strong> the benefits of using containers on DNAnexus for reproducibility and for batch processing</li>
<li><strong>Define</strong> the terms <em>image</em>, <em>container</em>, and <em>snapshot</em> in the context of Docker</li>
<li><strong>Create</strong> snapshots on RAP using <code>docker pull</code> and <code>docker save</code> with the ttyd app</li>
<li><strong>Utilize</strong> containers to batch process files on RAP</li>
<li><strong>Extend</strong> a docker image by installing within interactive mode</li>
<li><strong>Build</strong> a docker image using Dockerfiles</li>
</ol>
</section>
<section id="why-containers" class="level2" data-number="10.2">
<h2 data-number="10.2" class="anchored" data-anchor-id="why-containers"><span class="header-section-number">10.2</span> Why Containers?</h2>
<p>There is a replication crisis out there. Even given a script and the raw data, it is often difficult to replicate the results generated by a study.</p>
<p>Why is this difficult? Many others have talked about this, but one simple reason is that the results are tied to software and database versions.</p>
<p>This is the motivation for using <em>containers</em> - they are a way of packaging software that ‘freezes’ the software versions. If you provide the container that you used to generate the results, other people should be able to replicate your results even if they’re on a different operating system.</p>
</section>
<section id="terminology" class="level2" data-number="10.3">
<h2 data-number="10.3" class="anchored" data-anchor-id="terminology"><span class="header-section-number">10.3</span> Terminology</h2>
<p>In order to be unambiguous with our language, we’ll use the following definitions:</p>
<div id="fig-docker1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="images/docker_terminology.png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Figure&nbsp;10.1: Docker Terms 1</figcaption>
</figure>
</div>
<ul>
<li><strong>Registry</strong> - collection of repositories that you pull docker images from. Example repositories include DockerHub and Quay.io.</li>
<li><strong>Docker Image</strong> - what you download from a registry - the “recipe” for building the software environment. Stored in a registry. use <code>docker pull</code> to get image, <code>docker commit</code> to push changes to registry, can also generate image from a Dockerfile,</li>
<li><strong>Docker Container</strong> - The executable software environment installed on a machine. Runnable. Generate from <code>docker pull</code> from a repository.</li>
<li><strong>Snapshot File</strong> - An single archive file (<code>.tar.gz</code>) that contains the Docker container. Generate using <code>docker save</code> on a container. Also known as an <em>image file</em> on the platform.</li>
</ul>
</section>
<section id="building-docker-snapshot-files-on-the-the-dnanexus-platform" class="level2" data-number="10.4">
<h2 data-number="10.4" class="anchored" data-anchor-id="building-docker-snapshot-files-on-the-the-dnanexus-platform"><span class="header-section-number">10.4</span> Building Docker Snapshot Files on the the DNAnexus platform</h2>
<section id="the-golden-rule-of-docker-and-batch-analysis" class="level3" data-number="10.4.1">
<h3 data-number="10.4.1" class="anchored" data-anchor-id="the-golden-rule-of-docker-and-batch-analysis"><span class="header-section-number">10.4.1</span> The Golden Rule of Docker and Batch Analysis</h3>
<p>DockerHub has a pull limit of 200 pulls/day/user. You will face this limit a lot if you just use the image url.</p>
<p>So, if you are processing more than 200 files (or Jobs), you should save the docker image into platform storage as a snapshot file.</p>
<p>Let’s talk about the basic snapshot building process.</p>
</section>
<section id="be-secure" class="level3" data-number="10.4.2">
<h3 data-number="10.4.2" class="anchored" data-anchor-id="be-secure"><span class="header-section-number">10.4.2</span> Be Secure</h3>
<p>Before we get started, security is always a concern when running Docker images. The <code>docker</code> group has elevated status on a system, so we need to be careful that when we’re running them, they aren’t introducing any system vulnerabilities.</p>
<p>These are mostly important when running containers that are web-servers or part of a web stack, but it is also important to think about when running jobs on the cloud.</p>
<p>Here are some guidelines to think about when you are working with a container.</p>
<ul>
<li><strong>Use vendor-specific Docker Images when possible</strong>.</li>
<li><strong>Use container scanners to spot potential vulnerabilities</strong>. DockerHub has a vulnerability scanner that scans your Docker images for potential vulnerabilities.</li>
<li><strong>Avoid kitchen-sink images</strong>. One issue is when an image is built on top of many other images. It makes it really difficult to plug vulnerabilities. When in doubt, use images from trusted people and organizations.</li>
</ul>
</section>
<section id="the-basic-snapshot-building-process" class="level3" data-number="10.4.3">
<h3 data-number="10.4.3" class="anchored" data-anchor-id="the-basic-snapshot-building-process"><span class="header-section-number">10.4.3</span> The Basic Snapshot Building Process</h3>
<div id="fig-snapshot-building" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<div class="cell">
<div class="cell-output-display">
<div>
<div>
<pre class="mermaid mermaid-js">flowchart TD
  A[start ttyd] --&gt; B[docker pull &lt;br&gt; from registry]
  B --&gt; C[docker save to &lt;br&gt; snapshot file]
  C --&gt; D[dx upload &lt;br&gt; snapshot to &lt;br&gt; project storage]
  D --&gt; E[terminate ttyd]
</pre>
</div>
</div>
</div>
</div>
<figcaption class="figure-caption">Figure&nbsp;10.2: Building a docker snapshot on the DNAnexus platform.</figcaption>
</figure>
</div>
</section>
<section id="sec-ttyd" class="level3" data-number="10.4.4">
<h3 data-number="10.4.4" class="anchored" data-anchor-id="sec-ttyd"><span class="header-section-number">10.4.4</span> Building Snapshot Files in <code>ttyd</code></h3>
<p>Up until now, we have been using our own machine or the binder shell for doing our work.</p>
<p>We’re going to pull up a web-enabled shell on a DNAnexus worker with the <code>ttyd</code> app. <code>ttyd</code> is useful because:</p>
<ol type="1">
<li><code>docker</code> is already installed, so we can <code>docker pull</code> our container and <code>docker save</code> our snapshot to the ttyd instance.</li>
<li>It’s much faster to transfer our snapshot file back into project storage with <code>dx upload</code>.</li>
</ol>
<p>To open ttyd, open the <strong>Tool Library</strong> under <strong>Tools</strong> and select your project.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src=".png" class="img-fluid figure-img"></p>
<figcaption class="figure-caption">Opening ttyd</figcaption>
</figure>
</div>
</section>
<section id="pull-your-image-from-a-registry" class="level3" data-number="10.4.5">
<h3 data-number="10.4.5" class="anchored" data-anchor-id="pull-your-image-from-a-registry"><span class="header-section-number">10.4.5</span> Pull your image from a registry</h3>
<pre class="{bash}"><code>#| eval: false
docker pull quay.io/biocontainers/samtools:1.15.1--h1170115_0</code></pre>
<p>On your <code>ttyd</code> instance, do a <code>docker pull</code> to pull your image from the registry. Note that we’re pulling <code>samtools</code> from <code>quay.io</code> here, from the <code>biocontainers</code> user.</p>
<p>We’re also specifying a <em>version tag</em> - the <code>1.15.1--h1170115_0</code> to tie our <code>samtools</code> to a specific version. This is important - most <code>docker pull</code> operations will pull from the <code>latest</code> tag, which is not tied to a specific version. So make sure to tie your image to a specific version.</p>
<p>When you’re done pulling the docker image, try out the <code>docker images</code> command.</p>
<pre><code>docker images</code></pre>
</section>
<section id="try-your-docker-image-out" class="level3" data-number="10.4.6">
<h3 data-number="10.4.6" class="anchored" data-anchor-id="try-your-docker-image-out"><span class="header-section-number">10.4.6</span> Try your docker image out</h3>
<p>Now that we have our docker image downloaded, we can test it out by running <code>samtools --help</code>. This should give us the help message.</p>
<pre class="{bash}"><code>#| eval: false
docker run biocontainers/samtools samtools --help</code></pre>
</section>
<section id="save-your-docker-image-as-a-snapshot" class="level3" data-number="10.4.7">
<h3 data-number="10.4.7" class="anchored" data-anchor-id="save-your-docker-image-as-a-snapshot"><span class="header-section-number">10.4.7</span> Save your docker image as a snapshot</h3>
<p>Now that we’ve pulled the container, we are now going to save it as a snapshot file using <code>docker save</code>. We pipe the output of <code>docker save</code> into <code>gzip</code> to save it as <code>samtools_image.tar.gz</code>.</p>
<pre class="{bash}"><code>#| eval: false

docker save quay.io/biocontainers/samtools | gzip &gt; samtools_image.tar.gz </code></pre>
</section>
<section id="upload-your-snapshot" class="level3" data-number="10.4.8">
<h3 data-number="10.4.8" class="anchored" data-anchor-id="upload-your-snapshot"><span class="header-section-number">10.4.8</span> Upload your snapshot</h3>
<p>Now we can get our image back into project storage. We’ll create a folder called <code>images/</code> with <code>dx mkdir</code> and then use <code>dx upload</code> to get our snapshot file into the <code>images/</code> folder.</p>
<pre class="{bash}"><code>#| eval: false
dx mkdir images/
dx upload samtools_image.tar.gz --destination images/</code></pre>
</section>
<section id="important-make-sure-to-terminate-your-ttyd-instance" class="level3" data-number="10.4.9">
<h3 data-number="10.4.9" class="anchored" data-anchor-id="important-make-sure-to-terminate-your-ttyd-instance"><span class="header-section-number">10.4.9</span> Important: make sure to terminate your ttyd instance!</h3>
<p>One thing to remember is that there is no timeout associated with <code>ttyd</code>. You will get a reminder email after it’s been open after 24 hours, but you will get no warning after that.</p>
<p>So make sure to use <code>dx terminate</code> or terminate the ttyd job under the <code>Manage</code> tab.</p>
</section>
</section>
<section id="sec-docker-sak" class="level2" data-number="10.5">
<h2 data-number="10.5" class="anchored" data-anchor-id="sec-docker-sak"><span class="header-section-number">10.5</span> Using Docker with Swiss Army Knife</h2>
<p>Now that we’ve built our Docker snapshot, let’s use it in Swiss Army Knife.</p>
<p>Swiss Army Knife has two separate inputs associated with Docker:</p>
<ul>
<li><code>-iimage_file</code> - This is where you put the snapshot file (such as the <code>samtools.tar.gz</code>)</li>
<li><code>-iimage</code> - This is where you’d put the Docker URL (such as <code>quay.io/ucsc_cgl/samtools</code>)</li>
</ul>
<p>So, let’s run a <code>samtools</code> job using our Docker snapshot.</p>
<pre class="{bash}"><code>#| eval: false
dx run app-swiss-army-knife \
  -iimage_file="images/samtools.tar.gz" \
  -iin="data/NA12878.bam"
  -icmd="docker run samtools stats * &gt; ${in_prefix}.stats.txt"</code></pre>
<p>The main thing that has been changed here is that we’ve added an the <code>-iimage_file</code> input to our <code>dx run</code> statement.</p>
</section>
<section id="extending-a-docker-image" class="level2" data-number="10.6">
<h2 data-number="10.6" class="anchored" data-anchor-id="extending-a-docker-image"><span class="header-section-number">10.6</span> Extending a Docker Image</h2>
<p>One thing that you might do is extend a Docker image by adding additional software. You can do this by opening up an interactive mode and installing within the container.</p>
<p>What is interactive mode? When you pull a docker image in your <code>ttyd</code> session (<a href="#sec-ttyd"><span>Section&nbsp;10.4.4</span></a>), you can issue a <code>docker run</code> command with these options:</p>
<pre><code>docker run -it ubuntu:18.04 /bin/bash</code></pre>
<p>It will open up a bash shell in the container.</p>
<section id="pulling-a-base-image" class="level3" data-number="10.6.1">
<h3 data-number="10.6.1" class="anchored" data-anchor-id="pulling-a-base-image"><span class="header-section-number">10.6.1</span> Pulling a Base Image</h3>
<p>We’ll start out with the official ubuntu 18.04 container in our ttyd session:</p>
<pre class="{bash}"><code>#| eval: false
docker pull ubuntu:18.04
docker images</code></pre>
</section>
<section id="open-up-interactive-mode" class="level3" data-number="10.6.2">
<h3 data-number="10.6.2" class="anchored" data-anchor-id="open-up-interactive-mode"><span class="header-section-number">10.6.2</span> Open up interactive mode</h3>
<p>In ttyd, now enter an interactive session:</p>
<pre><code>docker run -it ubuntu:18.04 /bin/bash</code></pre>
<p>If it works, you will open up a <code>bash</code> prompt in the container.</p>
<p>You’ll know you’re in the container if you do an <code>ls</code> and your filesystem looks different.</p>
</section>
<section id="install-software" class="level3" data-number="10.6.3">
<h3 data-number="10.6.3" class="anchored" data-anchor-id="install-software"><span class="header-section-number">10.6.3</span> Install Software</h3>
<p>Now, let’s install <a href="https://emboss.sourceforge.net/">EMBOSS</a> (European Molecular Biology Open Software Suite), which is a suite of string utilities for working with genomic data. If you look at the EMBOSS link, you will see that you can install it via <code>apt install</code>, which is available by default in the <code>ubuntu</code> container.</p>
<pre class="{bash}"><code>#| eval: false
apt update &amp;&amp; apt upgrade
apt install emboss gzip -y</code></pre>
</section>
<section id="exit-container" class="level3" data-number="10.6.4">
<h3 data-number="10.6.4" class="anchored" data-anchor-id="exit-container"><span class="header-section-number">10.6.4</span> Exit Container</h3>
<p>Now exit from your container’s interactive mode:</p>
<pre class="{bash}"><code>#| eval: false
exit</code></pre>
<p>You’ll be back at the normal ttyd prompt.</p>
</section>
<section id="docker-commitdocker-save-your-new-snapshot-file" class="level3" data-number="10.6.5">
<h3 data-number="10.6.5" class="anchored" data-anchor-id="docker-commitdocker-save-your-new-snapshot-file"><span class="header-section-number">10.6.5</span> <code>docker commit</code>/<code>docker save</code> your new snapshot file</h3>
<p>We created a new container when we installed everything. We’ll need to find it its ID in ttyd.</p>
<pre class="{bash}"><code>#| eval: false
docker ps -a</code></pre>
<p>We can see that our new container has the following id. We can use this id to save a new container with <code>docker commit</code>. Now we can save the snapshot file by using <code>docker save</code>:</p>
<pre class="{bash}"><code>#| eval: false
docker commit &lt;container_id&gt; emboss:6.6.0
docker save emboss:6.6.0 | gzip &gt; emboss.tar.gz
dx upload emboss.tar.gz --destination images/</code></pre>
</section>
<section id="other-uses-of-interactive-mode" class="level3" data-number="10.6.6">
<h3 data-number="10.6.6" class="anchored" data-anchor-id="other-uses-of-interactive-mode"><span class="header-section-number">10.6.6</span> Other uses of Interactive Mode</h3>
<p>Docker’s interactive mode is really helpful for testing out scripts and making sure they are reproducible.</p>
<p>If I have a one-off analysis, it may be faster for me to just open up <code>ttyd</code> and use <code>docker run</code> to open up interactive mode, and do work with a container.</p>
</section>
</section>
<section id="making-dockerfiles" class="level2" data-number="10.7">
<h2 data-number="10.7" class="anchored" data-anchor-id="making-dockerfiles"><span class="header-section-number">10.7</span> Making Dockerfiles</h2>
<p>The other way to build image files is to use a Dockerfile. A Dockerfile is a recipe for installing software and its dependencies.</p>
<p>Let’s take a look at a Dockerfile. By default, it is contained within a folder and is called <code>Dockerfile</code>:</p>
<pre><code>FROM ubuntu:18.04

RUN apt-get update &amp;&amp; \
    apt-get install -y build-essential  &amp;&amp; \
    apt-get install -y wget &amp;&amp; \
    apt-get clean &amp;&amp; \
    rm -rf /var/lib/apt/lists/*

ENV CONDA_DIR /opt/conda
RUN wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda.sh &amp;&amp; \
     /bin/bash ~/miniconda.sh -b -p /opt/conda

ENV PATH=$CONDA_DIR/bin:$PATH

#install plink with conda
RUN conda install -c "bioconda/label/cf201901" plink
RUN conda install -c "bioconda/label/cf201901" samtools</code></pre>
<p>We can build the Docker image in our directory using:</p>
<pre><code>docker build . -t gatk_sam_plink:0.0.1</code></pre>
<p>When it’s done, we can then make sure it’s been built by using</p>
<pre><code>docker images</code></pre>
<p>And we can use it like any other image.</p>
</section>
<section id="going-further-with-docker" class="level2" data-number="10.8">
<h2 data-number="10.8" class="anchored" data-anchor-id="going-further-with-docker"><span class="header-section-number">10.8</span> Going Further with Docker</h2>
<p>Now that you know how to build a snapshot file, you’ve also learned another step in building apps: specifying software dependencies. You can use these snapshot files to specify executables in your app.</p>
<p>You can also use these snapshot files in your WDL workflow.</p>
</section>
<section id="what-you-learned-in-this-chapter" class="level2" data-number="10.9">
<h2 data-number="10.9" class="anchored" data-anchor-id="what-you-learned-in-this-chapter"><span class="header-section-number">10.9</span> What you learned in this chapter</h2>
<ul>
<li>How containers enable reproducibility</li>
<li>Defined specific container terminology</li>
<li>Created snapshot files using <code>ttyd</code></li>
<li>Use these snapshot files with Swiss Army Knife</li>
<li>How to extend a docker image by installing new software</li>
</ul>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./building-apps.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Building Apps</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./appendix.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">11</span>&nbsp; <span class="chapter-title">Appendix</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>