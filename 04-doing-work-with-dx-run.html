<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.1.251">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Bash for Bioinformatics - 5&nbsp; Working with files using dx run</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1.6em;
  vertical-align: middle;
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./05-batch-processing.html" rel="next">
<link href="./03-cloud-computing-basics.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script type="application/json" class="js-hypothesis-config">
{
  "theme": "clean",
  "openSidebar": false
}
</script>
<script async="" src="https://hypothes.is/embed.js"></script>


</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
    <div class="container-fluid d-flex justify-content-between">
      <h1 class="quarto-secondary-nav-title"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Working with files using <code>dx run</code></span></h1>
      <button type="button" class="quarto-btn-toggle btn" aria-label="Show secondary navigation">
        <i class="bi bi-chevron-right"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Bash for Bioinformatics</a> 
    </div>
      </div>
      <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
      </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./01-setup-course.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Setup for the Course / dx-toolkit basics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./02-scripting-basics.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Shell Scripting Basics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./03-cloud-computing-basics.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Cloud Computing Basics</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./04-doing-work-with-dx-run.html" class="sidebar-item-text sidebar-link active"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Working with files using <code>dx run</code></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05-batch-processing.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Batch Processing on the Cloud</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./06-JSON.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Working with JSON on the DNAnexus Platform</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./07-containers.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Containers and Reproducibility</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./appendix.html" class="sidebar-item-text sidebar-link"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Appendix</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./references.html" class="sidebar-item-text sidebar-link">References</a>
  </div>
</li>
    </ul>
    </div>
</nav>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#learning-objectives" id="toc-learning-objectives" class="nav-link active" data-scroll-target="#learning-objectives"><span class="toc-section-number">5.1</span>  Learning Objectives</a></li>
  <li><a href="#doing-bioinformatics-with-the-swiss-army-knife-sak-app" id="toc-doing-bioinformatics-with-the-swiss-army-knife-sak-app" class="nav-link" data-scroll-target="#doing-bioinformatics-with-the-swiss-army-knife-sak-app"><span class="toc-section-number">5.2</span>  Doing Bioinformatics with the Swiss Army Knife (SAK) App</a></li>
  <li><a href="#running-jobs-on-the-dnanexus-platform-using-dx-run" id="toc-running-jobs-on-the-dnanexus-platform-using-dx-run" class="nav-link" data-scroll-target="#running-jobs-on-the-dnanexus-platform-using-dx-run"><span class="toc-section-number">5.3</span>  Running Jobs on the DNAnexus platform using <code>dx run</code></a></li>
  <li><a href="#try-out-your-first-job" id="toc-try-out-your-first-job" class="nav-link" data-scroll-target="#try-out-your-first-job"><span class="toc-section-number">5.4</span>  Try out your first job</a>
  <ul class="collapse">
  <li><a href="#what-about-the-outputs" id="toc-what-about-the-outputs" class="nav-link" data-scroll-target="#what-about-the-outputs"><span class="toc-section-number">5.4.1</span>  What about the outputs?</a></li>
  </ul></li>
  <li><a href="#building-on-our-first-dx-run-job" id="toc-building-on-our-first-dx-run-job" class="nav-link" data-scroll-target="#building-on-our-first-dx-run-job"><span class="toc-section-number">5.5</span>  Building on our first <code>dx run</code> job</a>
  <ul class="collapse">
  <li><a href="#submitting-a-script-to-the-worker" id="toc-submitting-a-script-to-the-worker" class="nav-link" data-scroll-target="#submitting-a-script-to-the-worker"><span class="toc-section-number">5.5.1</span>  Submitting a script to the worker</a></li>
  <li><a href="#bash-helper-variables" id="toc-bash-helper-variables" class="nav-link" data-scroll-target="#bash-helper-variables"><span class="toc-section-number">5.5.2</span>  Bash Helper Variables</a></li>
  </ul></li>
  <li><a href="#more-swiss-army-knife" id="toc-more-swiss-army-knife" class="nav-link" data-scroll-target="#more-swiss-army-knife"><span class="toc-section-number">5.6</span>  More Swiss Army Knife</a>
  <ul class="collapse">
  <li><a href="#multiple-file-inputs-to-swiss-army-knife" id="toc-multiple-file-inputs-to-swiss-army-knife" class="nav-link" data-scroll-target="#multiple-file-inputs-to-swiss-army-knife"><span class="toc-section-number">5.6.1</span>  Multiple file inputs to Swiss Army Knife</a></li>
  <li><a href="#sec-plink" id="toc-sec-plink" class="nav-link" data-scroll-target="#sec-plink"><span class="toc-section-number">5.6.2</span>  Using PLINK triplets</a></li>
  </ul></li>
  <li><a href="#dx-run-runs-deep" id="toc-dx-run-runs-deep" class="nav-link" data-scroll-target="#dx-run-runs-deep"><span class="toc-section-number">5.7</span>  <code>dx run</code> runs deep</a>
  <ul class="collapse">
  <li><a href="#save-our-output-files-into-a-different-folder" id="toc-save-our-output-files-into-a-different-folder" class="nav-link" data-scroll-target="#save-our-output-files-into-a-different-folder"><span class="toc-section-number">5.7.1</span>  Save our output files into a different folder</a></li>
  <li><a href="#run-our-job-on-a-different-instance-type" id="toc-run-our-job-on-a-different-instance-type" class="nav-link" data-scroll-target="#run-our-job-on-a-different-instance-type"><span class="toc-section-number">5.7.2</span>  Run our job on a different instance type</a></li>
  <li><a href="#tag-and-rename-our-job" id="toc-tag-and-rename-our-job" class="nav-link" data-scroll-target="#tag-and-rename-our-job"><span class="toc-section-number">5.7.3</span>  Tag and rename our job</a></li>
  <li><a href="#clone-an-failed-job" id="toc-clone-an-failed-job" class="nav-link" data-scroll-target="#clone-an-failed-job"><span class="toc-section-number">5.7.4</span>  Clone an failed job</a></li>
  </ul></li>
  <li><a href="#dxfuse-simplify-your-scripts-with-multiple-inputs" id="toc-dxfuse-simplify-your-scripts-with-multiple-inputs" class="nav-link" data-scroll-target="#dxfuse-simplify-your-scripts-with-multiple-inputs"><span class="toc-section-number">5.8</span>  dxFUSE: Simplify your scripts with multiple inputs</a>
  <ul class="collapse">
  <li><a href="#advantages-of-dxfuse" id="toc-advantages-of-dxfuse" class="nav-link" data-scroll-target="#advantages-of-dxfuse"><span class="toc-section-number">5.8.1</span>  Advantages of dxFUSE</a></li>
  <li><a href="#disadvantages-of-dxfuse" id="toc-disadvantages-of-dxfuse" class="nav-link" data-scroll-target="#disadvantages-of-dxfuse"><span class="toc-section-number">5.8.2</span>  Disadvantages of dxFUSE</a></li>
  </ul></li>
  <li><a href="#using-a-docker-image-with-dx-runswiss-army-knife" id="toc-using-a-docker-image-with-dx-runswiss-army-knife" class="nav-link" data-scroll-target="#using-a-docker-image-with-dx-runswiss-army-knife"><span class="toc-section-number">5.9</span>  Using a Docker Image with <code>dx run</code>/Swiss Army Knife</a></li>
  <li><a href="#what-you-learned-in-this-chapter" id="toc-what-you-learned-in-this-chapter" class="nav-link" data-scroll-target="#what-you-learned-in-this-chapter"><span class="toc-section-number">5.10</span>  What you learned in this chapter</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content page-columns page-full" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span id="sec-dxrun" class="quarto-section-identifier d-none d-lg-block"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Working with files using <code>dx run</code></span></span></h1>
</div>



<div class="quarto-title-meta">

    
    
  </div>
  

</header>

<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Prep for Exercises
</div>
</div>
<div class="callout-body-container callout-body">
<p>In your shell, make sure you’re in the <code>bash_bioinfo_scripts/04-doing-work-with-dx-run/</code> folder:</p>
<pre><code>cd 04-doing-work-with-dx-run/</code></pre>
</div>
</div>
<section id="learning-objectives" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="learning-objectives"><span class="header-section-number">5.1</span> Learning Objectives</h2>
<ol type="1">
<li><strong>Utilize</strong> an all purpose app (<code>swiss-army-knife</code>) to run bioinformatics jobs using <code>dx run</code> on files in a DNAnexus project</li>
<li><strong>Utilize</strong> multiple inputs in a Swiss Army Knife job.</li>
<li><strong>Explain</strong> and <strong>utilize</strong> multiple options in a Swiss Army Knife job.</li>
<li><strong>Wrap</strong> R and Python scripts using a bash script to run it on the cloud using <code>dx run</code></li>
<li><strong>Tag</strong> output files on the platform for downstream use.</li>
</ol>
</section>
<section id="doing-bioinformatics-with-the-swiss-army-knife-sak-app" class="level2 page-columns page-full" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="doing-bioinformatics-with-the-swiss-army-knife-sak-app"><span class="header-section-number">5.2</span> Doing Bioinformatics with the Swiss Army Knife (SAK) App</h2>
<p>Let’s focus on key bioinformatics tasks we need to accomplish. To make things easier, we’ll be using <a href="https://platform.dnanexus.com/app/swiss-army-knife">Swiss Army Knife</a>, which is an app on the platform that contains a number of commonly used bioinformatics utilities, including:</p>
<div class="column-body quarto-layout-panel">
<div class="quarto-layout-row quarto-layout-valign-top">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: center;">
<ul>
<li><code>bcftools</code></li>
<li><code>bedtools</code></li>
<li><code>BGEN</code></li>
<li><code>bgzip</code></li>
<li><code>BOLT-LMM</code></li>
<li><code>Picard</code></li>
<li><code>Plato</code></li>
<li><code>plink</code></li>
<li><code>plink2</code></li>
<li><code>QCTool</code></li>
<li><code>REGENIE</code></li>
<li><code>sambamba</code></li>
<li><code>samtools</code></li>
<li><code>seqtk</code></li>
<li><code>tabix</code></li>
<li><code>vcflib</code></li>
<li><code>vcftools</code></li>
</ul>
</div>
</div>
</div>
<p>Swiss Army Knife also contains R and Python 3.</p>
<p>Everything you’ll learn in this section will also be applicable to building apps on the platform as well. You’ll learn the foundations of running a script on the platform, which is halfway to building your own apps on the platform.</p>
</section>
<section id="running-jobs-on-the-dnanexus-platform-using-dx-run" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="running-jobs-on-the-dnanexus-platform-using-dx-run"><span class="header-section-number">5.3</span> Running Jobs on the DNAnexus platform using <code>dx run</code></h2>
<p>Our main command for running jobs is <code>dx run</code>. <code>dx run</code> lets us submit jobs to be run on the platform. These jobs can be to process files (such as aligning FASTQ files to a genome), or they can be for web apps, such as LocusZoom (for visualizing)</p>
<p>If you have used SLURM on an on-premise HPC system, the equivalent command would be <code>srun</code>, and if you have used PBS, the equivalent command would be <code>sbatch</code>.</p>
</section>
<section id="try-out-your-first-job" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="try-out-your-first-job"><span class="header-section-number">5.4</span> Try out your first job</h2>
<p>In the sample project, you will see a <code>.bam</code> file in <code>data/</code> called <code>NA12878.bam</code> with no index. Let’s create an index for this file with <code>sambamba</code> by running it with <code>dx run app-swiss-army-knife</code>.</p>
<pre class="{bash}"><code>#| eval: false
#| filename: 04-doing-work-with-dx-run/run-sambamba.sh
#! /bin/bash
dx run app-swiss-army-knife \
  -iin="/data/NA12878.bam" \ 
  -icmd="sambamba index *"</code></pre>
<p>Let’s take this code apart. We start our command with <code>dx run</code> and the name of the app on the platform we want to use: <code>app-swiss-army-knife</code>.</p>
<p>The second line contains the file input we want to process, which is a file in our current project. Note that the input is specified as <code>-iin</code>, not <code>--in</code> or <code>--iin</code>. Using a single hyphen <code>-</code> here instead of a double hyphen <code>--</code> for our inputs is different than we might expect for other linux/UNIX parameters.</p>
<p>The third line is the actual command we want to run in Swiss Army Knife. We want to run <code>sambamba index</code> on our input file.</p>
<p>When you run the above code, either by pasting it into your shell, or using <code>bash run-sambamba.sh</code> you’ll see the following response.</p>
<pre><code>Using input JSON:
{
    "cmd": "sambamba index *",
    "in": [
        {
            "$dnanexus_link": {
                "project": "project-GGyyqvj0yp6B82ZZ9y23Zf6q",
                "id": "file-FpQKQk00FgkGV3Vb3jJ8xqGV"
            }
        }
    ]
}

Confirm running the executable with this input [Y/n]: Y
Calling app-GFxJgVj9Q0qQFykQ8X27768Y with output destination
  project-GGyyqvj0yp6B82ZZ9y23Zf6q:/

Job ID: job-GJ0G58Q0yp65gzJzKjYv04bZ
Watch launched job now? [Y/n] Y</code></pre>
<p>Respond with <code>Y</code> when it asks</p>
<p><code>Confirm executable with this input [Y/n]:</code></p>
<p>And when it asks you</p>
<p><code>Watch launched job now? [Y/n]</code></p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Try it out!
</div>
</div>
<div class="callout-body-container callout-body">
<p>Run the above code (also in <code>04-doing-work-with-dx-run/run-sambamba.sh</code>) and look at the log that is generated. Take a look at it carefully, especially the output log.</p>
<p>What file does it create? Where does it create that file?</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center" data-bs-toggle="collapse" data-bs-target=".callout-3-contents" aria-controls="callout-3" aria-expanded="false" aria-label="Toggle callout">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Answer
</div>
<div class="callout-btn-toggle d-inline-block border-0 py-1 ps-1 pe-0 float-end"><i class="callout-toggle"></i></div>
</div>
<div id="callout-3" class="callout-3-contents callout-collapse collapse">
<div class="callout-body-container callout-body">
<p>If you use <code>dx tree</code> to take a look at the project, you’ll see that there was a file <code>NA12878.bam.bai</code> that was created in the root of our project.</p>
<pre><code>dx tree

── data
│   ├── NA12878.bai
│   ├── NA12878.bam
│   ├── NC_000868.fasta
│   ├── NC_001422.fasta
│   ├── small-celegans-sample.fastq
│   ├── SRR100022_chrom20_mapped_to_b37.bam
│   ├── SRR100022_chrom21_mapped_to_b37.bam
│   └── SRR100022_chrom22_mapped_to_b37.bam
└── NA12878.bam.bai</code></pre>
<p>If we wanted to control where our index file ended up, we can use the <code>--destination</code> option to specify our destination, such as</p>
<p><code>--destination data/</code></p>
</div>
</div>
</div>
<section id="what-about-the-outputs" class="level3" data-number="5.4.1">
<h3 data-number="5.4.1" class="anchored" data-anchor-id="what-about-the-outputs"><span class="header-section-number">5.4.1</span> What about the outputs?</h3>
<p>One of the nice things about Swiss Army Knife is that it automatically transfers files that we generate on the worker. In our above job, we generated the corresponding index file <code>NA12878.bam.bai</code> from our <code>-icmd</code> input. It was automatically transferred over from the worker to the root of our project.</p>
<p>If we wanted to change the output folder, we can use the <code>--destination</code> flag, like below:</p>
<pre class="{bash}"><code>#| eval: false

dx run app-swiss-army-knife \
  -iin="/data/NA12878.bam" \ 
  -icmd="sambamba index *"
  --destination "data/"</code></pre>
<p>Another nice thing about <code>dx run</code> is that it will automatically create the folder we specify with <code>--destination</code> if it doesn’t exist in project storage.</p>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
What if we run our statement multiple times?
</div>
</div>
<div class="callout-body-container callout-body">
<p>We can actually run our <code>dx run</code> statement multiple times. The output will be multiple files with the same name in the <code>destination</code> directory.</p>
<p>What’s going on here? Well, files are considered as <em>objects</em> on the platform. Each copy generated by our <code>dx run</code> are considered unique objects on the platform, with separate file identifiers.</p>
</div>
</div>
</section>
</section>
<section id="building-on-our-first-dx-run-job" class="level2" data-number="5.5">
<h2 data-number="5.5" class="anchored" data-anchor-id="building-on-our-first-dx-run-job"><span class="header-section-number">5.5</span> Building on our first <code>dx run</code> job</h2>
<p>We’ve seen how to specify file inputs to Swiss Army Knife. Let’s dive into some of the intricacies of using the <code>-icmd</code> input.</p>
<section id="submitting-a-script-to-the-worker" class="level3" data-number="5.5.1">
<h3 data-number="5.5.1" class="anchored" data-anchor-id="submitting-a-script-to-the-worker"><span class="header-section-number">5.5.1</span> Submitting a script to the worker</h3>
<p>The <code>-icmd</code> input is helpful for small scripting jobs, but you often want to do a bunch of things in a Swiss Army Knife job.</p>
<p>Bash scripting to the rescue! Say we have a script called <code>run-on-worker.sh</code> that takes 1 positional input, which is a file path. We’ll run this script on the worker:</p>
<pre class="{bash}"><code>#| eval: false
#| filename: worker-scripts/run-on-worker.sh

sambamba $1 &gt; $1.bai
samtools stats $1 &gt; $1.stats.txt</code></pre>
<p>When we set up a <code>dx run app-swiss-army-knife</code>, we’ll use this script as one of the inputs to <code>dx run</code>:</p>
<pre class="{bash}"><code>#| eval: false
#| filename: 04-doing-work-with-dx-run/dx-run-script.sh

dx run app-swiss-army-knife \
  -iin="worker_scripts/run-on-worker.sh` \
  -iin="data/NA12878.bam" \
  -icmd="bash run-on-worker.sh $in_path"</code></pre>
<p>The magic here is that we’re using <code>bash</code> in our <code>cmd</code> input to run the script <code>run-on-worker.sh</code>. Notice this script is already in our project in the <code>worker_scripts/</code> folder, so we can submit it as a file input:</p>
<pre><code>-iin="worker_scripts/run-on-worker.sh"</code></pre>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Why this is important on the platform
</div>
</div>
<div class="callout-body-container callout-body">
<p>This is a common pattern that we’ll use when we need to do more complicated things with Swiss Army Knife. It doesn’t seem that helpful right now, but it will once we get to batch scripting.</p>
</div>
</div>
<p>You’ll notice that we are using a special helper variable here called <code>${in_path}</code> - this gives the current path of the file on the <em>worker</em>. It is tremendously helpful in scripting. Let’s learn about these built-in helper variables next.</p>
</section>
<section id="bash-helper-variables" class="level3" data-number="5.5.2">
<h3 data-number="5.5.2" class="anchored" data-anchor-id="bash-helper-variables"><span class="header-section-number">5.5.2</span> Bash Helper Variables</h3>
<p>There are some helper variables based on the file inputs specified in <code>-iin</code>.</p>
<p>These variables are really helpful in scripting in our <code>-icmd</code> input. Say we ran our command:</p>
<pre><code>dx run app-swiss-army-knife \
  -iin="/data/NA12878.bam" \ 
  -icmd="sambamba index ${in_path}"</code></pre>
<p>You’ll see that we are using a special variable called <code>$in_path</code> here to specify the file name. This is called a <em>helper variable</em> - they are available based on the different file inputs we submit to Swiss Army Knife.</p>
<p>For our one input <code>-iin="data/NA12878.bam"</code>, this is what these helper variables contain:</p>
<table class="table">
<thead>
<tr class="header">
<th>Bash Variable</th>
<th>Value</th>
<th>Notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><code>$in</code></td>
<td><code>data/NA12878.bam</code></td>
<td>Location in project storage</td>
</tr>
<tr class="even">
<td><code>$in_path</code></td>
<td><code>~/NA12878.bam</code></td>
<td>Location in worker storage</td>
</tr>
<tr class="odd">
<td><code>$in_name</code></td>
<td><code>NA12878.bam</code></td>
<td>File name (without folder path)</td>
</tr>
<tr class="even">
<td><code>$in_prefix</code></td>
<td><code>NA12878</code></td>
<td>File name without the suffix</td>
</tr>
</tbody>
</table>
<p><code>$in_prefix</code> is really helpful when you want to create files that have the same prefix as our file. Say we wanted to run <code>samtools view -c</code> on our file. We want a file called <code>NA12878.count.txt</code> that contains the read counts.</p>
<pre><code>dx run app-swiss-army-knife \
  -iin="data/NA12878.bam" \
  -icmd="samtools view -c ${in_path} &gt; ${in_prefix}.counts.txt"</code></pre>
<p>What happens when the command is run on the worker is that the variables are expanded like this:</p>
<pre><code>samtools view -c ~/NA12878.bam &gt; NA12878.counts.txt</code></pre>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
What is the difference between <code>$in</code> and <code>$in_path</code>?
</div>
</div>
<div class="callout-body-container callout-body">
<p>You may have looked at the above table and been slightly confused about these two variables.</p>
<p><code>$in</code> is the file location in <strong>project storage</strong>, while <code>$in_path</code> is the file location in the temporary <strong>worker storage</strong>.</p>
<p>When writing scripts that run on the worker with the <code>-icmd</code> input, <code>$in_path</code> is much more useful.</p>
</div>
</div>
<div class="callout-note callout callout-style-default callout-captioned">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-caption-container flex-fill">
Why are we learning about helper variables?
</div>
</div>
<div class="callout-body-container callout-body">
<p>Writing scripts that can be run on the worker is part of the app building process, which lets us specify our own executables.</p>
<p>If you can get a handle on working with helper variables in <code>-icmd</code>, then you are most of the way to building an app.</p>
</div>
</div>
</section>
</section>
<section id="more-swiss-army-knife" class="level2" data-number="5.6">
<h2 data-number="5.6" class="anchored" data-anchor-id="more-swiss-army-knife"><span class="header-section-number">5.6</span> More Swiss Army Knife</h2>
<p>There is a table in the <a href="https://platform.dnanexus.com/app/swiss-army-knife">Swiss Army Knife documentation</a> that specifies the inputs and how to configure the <code>-icmd</code> parameter for each operation.</p>
<p>One thing you’ll notice is that some of them require multiple file inputs. How do you specify them?</p>
<section id="multiple-file-inputs-to-swiss-army-knife" class="level3" data-number="5.6.1">
<h3 data-number="5.6.1" class="anchored" data-anchor-id="multiple-file-inputs-to-swiss-army-knife"><span class="header-section-number">5.6.1</span> Multiple file inputs to Swiss Army Knife</h3>
<p>One thing that may not be apparent to you is that you can specify multiple file inputs with multiple <code>-iin</code> options.</p>
<p>The Swiss Army Knife Documentation notes that <code>-iin</code> is actually an <em>array</em> file input. That means that we can submit multiple files like this:</p>
<pre class="{bash}"><code>#| eval: false
#| filename: 04-doing-work-with-dx-run/dx-run-multiple-inputs.sh

dx run app-swiss-army-knife \
  -iin="data/SRR100022_chrom20_mapped_to_b37.bam" \
  -iin="data/SRR100022_chrom21_mapped_to_b37.bam" \
  -iin="data/SRR100022_chrom22_mapped_to_b37.bam" \
  -icmd="ls *.bam | xargs -I% sh -c 'samtools view -c % &gt; %.count.txt'"</code></pre>
<p>If we want to process each of these files, we’ll have to use <code>xargs</code> in our <code>icmd</code> statement:</p>
<pre><code>-icmd="ls *.bam | xargs -I% sh -c 'samtools view -c % &gt; %.count.txt'"</code></pre>
<p>We’ll cover more of this in <a href="05-batch-processing.html"><span>Chapter&nbsp;6</span></a>.</p>
</section>
<section id="sec-plink" class="level3" data-number="5.6.2">
<h3 data-number="5.6.2" class="anchored" data-anchor-id="sec-plink"><span class="header-section-number">5.6.2</span> Using PLINK triplets</h3>
<p>If we’re working with a PLINK trio of files (<code>.bed</code>, <code>.bim</code>, and <code>.fam</code> files), we can use the file inputs as below. We’ll submit the trio of files separately, and use the <code>--bfile</code> option in <code>plink</code> to specify all three files.</p>
<pre class="{bash}"><code>#| eval: false
#| filename 04-doing-work-with-dx-run/run-plink.sh

dx run app-swiss-army-knife \
  -iin="data/chr1.bed" \
  -iin="data/chr1.bim" \
  -iin="data/chr1.fam" \
  -icmd="plink --bfile chr1 --geno 0.01 --make-bed --out chr1_qc"</code></pre>
<p>We will output the QC’ed and filtered files as <code>chr1_qc.bed</code>, <code>chr1_qc.bim</code>, and <code>chr1_qc.fam</code>. We do that by specifiying the <code>--out</code> option for <code>plink</code>.</p>
</section>
</section>
<section id="dx-run-runs-deep" class="level2" data-number="5.7">
<h2 data-number="5.7" class="anchored" data-anchor-id="dx-run-runs-deep"><span class="header-section-number">5.7</span> <code>dx run</code> runs deep</h2>
<p>If you’ve looked at the <code>dx run</code> help page, you’ll notice it is quite long. There are a lot of options. Let’s look at a few of them that are really helpful when you’re getting started.</p>
<ul>
<li><code>--tag</code> - please use these.</li>
<li><code>--destination</code> - destination folder in project. If the path doesn’t exist, it will be created.</li>
<li><code>--instance-type</code> - Instance types used in the job.</li>
<li><code>--watch</code> - run <code>dx watch</code> for the job id that is generated</li>
<li><code>-y</code> - non-interactive mode. Replies yes to the questions and starts up <code>dx watch</code> for that job id.</li>
<li><code>--allow-ssh</code> - very helpful in debugging jobs. Allows you to <code>dx ssh</code> into that worker and check out the status.</li>
<li><code>--batch-tsv</code> - works with the tab-delimited files that you generate using <code>dx generate_batch_inputs</code>.</li>
<li><code>--detach</code> - if a subjob of a job, it detaches the job. This is really important in batch operations where a top-level job is generating a subjob. Running the subjobs as detached means that the entire top-level job will not fail if a subjob fails.</li>
</ul>
<p>I’ll outline some examples where we leverage the options below.</p>
<section id="save-our-output-files-into-a-different-folder" class="level3" data-number="5.7.1">
<h3 data-number="5.7.1" class="anchored" data-anchor-id="save-our-output-files-into-a-different-folder"><span class="header-section-number">5.7.1</span> Save our output files into a different folder</h3>
<p>As we mentioned above, by default our output files are generated in the root folder of the project. If we want to control this, we can use the <code>--destination</code> option.</p>
<p>Remember, if the folder our <code>--destination</code> option doesn’t exist, <code>dx run</code> will create that folder and send the outputs into the newly created folder.</p>
<pre class="{bash}"><code>#| eval: false
#| filename: 04-doing-work-with-dx-run/run-destination.sh
dx run app-swiss-army-knife \
  -iin="data/chr1.bed" \
  -iin="data/chr1.bim" \
  -iin="data/chr1.fam" \
  -icmd="plink --bfile chr1 --geno 0.01 --make-bed --out chr1_qc" \
  --destination "results/"</code></pre>
</section>
<section id="run-our-job-on-a-different-instance-type" class="level3" data-number="5.7.2">
<h3 data-number="5.7.2" class="anchored" data-anchor-id="run-our-job-on-a-different-instance-type"><span class="header-section-number">5.7.2</span> Run our job on a different instance type</h3>
<pre class="{bash}"><code>#| eval: false
#| filename: 04-doing-work-with-dx-run/run-instance.sh
dx run app-swiss-army-knife \
  -iin="data/chr1.bed" \
  -iin="data/chr1.bim" \
  -iin="data/chr1.fam" \
  -icmd="plink --bfile chr1 --geno 0.01 --make-bed --out chr1_qc" \
  --instance-type "mem1_ssd1_v2_x8"</code></pre>
</section>
<section id="tag-and-rename-our-job" class="level3" data-number="5.7.3">
<h3 data-number="5.7.3" class="anchored" data-anchor-id="tag-and-rename-our-job"><span class="header-section-number">5.7.3</span> Tag and rename our job</h3>
<pre class="{bash}"><code>#| eval: false
#| filename: 04-doing-work-with-dx-run/run-job-tag-name.sh
dx run app-swiss-army-knife \
  -iin="data/chr1.bed" \
  -iin="data/chr1.bim" \
  -iin="data/chr1.fam" \
  -icmd="plink --bfile chr1 --geno 0.01 --make-bed --out chr1_qc" \
  --tag "plink_job" --name "Run PLINK on fileset: $in_prefix"</code></pre>
</section>
<section id="clone-an-failed-job" class="level3" data-number="5.7.4">
<h3 data-number="5.7.4" class="anchored" data-anchor-id="clone-an-failed-job"><span class="header-section-number">5.7.4</span> Clone an failed job</h3>
<p>If you have run a job on a lower priority, your job has a chance of getting bumped (stopped). If that’s the case, your job will fail.</p>
<pre class="{bash}"><code>#| eval: false
dx run app-swiss-army-knife --clone &lt;job-id&gt;</code></pre>
<p>When we learn about JSON (#sec-json), we’ll learn a recipe for restarting a list of these failed jobs.</p>
</section>
</section>
<section id="dxfuse-simplify-your-scripts-with-multiple-inputs" class="level2" data-number="5.8">
<h2 data-number="5.8" class="anchored" data-anchor-id="dxfuse-simplify-your-scripts-with-multiple-inputs"><span class="header-section-number">5.8</span> dxFUSE: Simplify your scripts with multiple inputs</h2>
<p>Ok, we learned about submitting files as inputs. Is there a way to run scripts with less typing?</p>
<p>There is a general method for working in Swiss Army Knife and other apps that lets you bypass specifying file inputs explicitly in your <code>dx run</code> statement: using the <a href="https://github.com/dnanexus/dxfuse">dxFUSE file system</a>.</p>
<p>The main thing you need to know as a developer is that you can prepend a <code>/mnt/project/</code> to your file path to use in your <code>-icmd</code> input directly. For the <code>dx run</code> statement in <a href="#sec-plink"><span>Section&nbsp;5.6.2</span></a>, we can rewrite it as the following:</p>
<pre class="{bash}"><code>#| eval: false
#| filename: 04-doing-work-with-dx-run/run-job_dxfuse.sh

dx run app-swiss-army-knife \
  -icmd="plink --bfile /mnt/project/data/chr1 --geno 0.01 --make-bed --out chr1_qc"</code></pre>
<p>In our <code>-icmd</code> input, we are referring to the file location of the triplet by pre-pending a <code>/mnt/project/</code> to the project path of the triplet: <code>data/chr1</code>.</p>
<section id="advantages-of-dxfuse" class="level3" data-number="5.8.1">
<h3 data-number="5.8.1" class="anchored" data-anchor-id="advantages-of-dxfuse"><span class="header-section-number">5.8.1</span> Advantages of dxFUSE</h3>
<p>Most of my scripts leverage dxFUSE. Let’s talk about the advantages of using <code>dxFUSE</code>.</p>
<ul>
<li><strong>You don’t have to specify files as inputs</strong>. This avoids a lot of typing in your scripts. This can be very helpful if there are a number of files you need as inputs per job.</li>
<li><strong>Allows you to stream files</strong>. dxFUSE is a file streaming method. That is, it will stream files bit by bit to the worker. This can make the overall job run somewhat faster, as it can stream files as needed, and not have to explicitly transfer each file to the worker.</li>
</ul>
</section>
<section id="disadvantages-of-dxfuse" class="level3" data-number="5.8.2">
<h3 data-number="5.8.2" class="anchored" data-anchor-id="disadvantages-of-dxfuse"><span class="header-section-number">5.8.2</span> Disadvantages of dxFUSE</h3>
<p>There are some disadvantages to using dxFUSE you should be aware of:</p>
<ul>
<li><strong>It obscures your audit trail.</strong> Because we are not specifying the files as inputs, it is less obvious as to which files were processed with each job.</li>
<li><strong>It works best as read-only.</strong> dxFUSE has limited write capabilities at this point, so it is best to treat it as a read-only file system.</li>
<li><strong>You have to be aware of how it resolves duplicate file names in a folder</strong>. dxFUSE works differently than what you might expect when it encounters multiple file names. It separates out duplicate files by prefacing them with a number. For example, if you generated three files called <code>chr1.results.txt</code> in a folder called <code>data</code>, this is how you would refer to each of them:</li>
</ul>
<pre><code>data/chr1_results.txt
data/1/chr1_results.txt
data/2/chr1_results.txt</code></pre>
<p>This name resolution can be tricky to work with. - <strong>It works best with good file hygiene practices.</strong> One of the confusing things is that you can create files with the same filename in the same folder (see previous point). This can easily happen if you clone a job. Because these two files have unique identifiers, they are allowed to have identical file names on the platform. This is one reason to tag each set of jobs with a run number (such as <code>run001</code>), so you can make sure that all of the updated files are the correct version.</p>
</section>
</section>
<section id="using-a-docker-image-with-dx-runswiss-army-knife" class="level2" data-number="5.9">
<h2 data-number="5.9" class="anchored" data-anchor-id="using-a-docker-image-with-dx-runswiss-army-knife"><span class="header-section-number">5.9</span> Using a Docker Image with <code>dx run</code>/Swiss Army Knife</h2>
<p>See the containers chapter (<a href="07-containers.html"><span>Chapter&nbsp;8</span></a>) for more information.</p>
</section>
<section id="what-you-learned-in-this-chapter" class="level2" data-number="5.10">
<h2 data-number="5.10" class="anchored" data-anchor-id="what-you-learned-in-this-chapter"><span class="header-section-number">5.10</span> What you learned in this chapter</h2>
<p>Kudos and congrats for reaching this far. We built upon our shell scripting skills (<a href="02-scripting-basics.html"><span>Chapter&nbsp;3</span></a>) and our knowledge of cloud-computing (<a href="03-cloud-computing-basics.html"><span>Chapter&nbsp;4</span></a>) to start running jobs effectively in the cloud.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    target: function(trigger) {
      return trigger.previousElementSibling;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    setTimeout(function() {
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const cites = ref.parentNode.getAttribute('data-cites').split(' ');
    tippyHover(ref, function() {
      var popup = window.document.createElement('div');
      cites.forEach(function(cite) {
        var citeDiv = window.document.createElement('div');
        citeDiv.classList.add('hanging-indent');
        citeDiv.classList.add('csl-entry');
        var biblioDiv = window.document.getElementById('ref-' + cite);
        if (biblioDiv) {
          citeDiv.innerHTML = biblioDiv.innerHTML;
        }
        popup.appendChild(citeDiv);
      });
      return popup.innerHTML;
    });
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./03-cloud-computing-basics.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Cloud Computing Basics</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./05-batch-processing.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Batch Processing on the Cloud</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>